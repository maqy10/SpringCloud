###### 官网：https://github.com/Netflix/Hystrix/wiki/How-To-Use

Hystrix 一般用在消费侧做服务降级

###### 1. 服务雪崩：

**多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其它的微服务，这就是所谓的“扇出”。**

如果**扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”**。

对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。

所以，**通常当一个模块下的某个实例失败后，这时候这个模块依然还会接收流量 ，然后这个有问题的模块还调用了其他的模块，这样就会发生级联故障，或者叫雪崩**。



2. ###### Hystrix

**Hystrix是一个用于处理分布式系统的延迟和容错的开源库**，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，**Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性**。

**断路器 本身是一种开关装置，当某个服务单元发生故障后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack),**而不是长时间的等待或者抛出调用方无法处理的异常，这样就**保证了服务调用方的线程不会被长时间、不必要地占用**，**从而避免了故障在分布式系统中的蔓延，乃至雪崩。**



3. ###### Hystrix重要概念

   **服务降级：fallback**

   ​	1)  服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示，fallback

   ​	2)  哪些情况会触发降级：

   ​			① 程序运行异常

   ​			② 超时

   ​			③ 服务熔断触发服务降级

   ​			④ 线程池/信号量打满也会导致服务降级

   **服务熔断： break**

   ​	达到最大服务访问后，直接拒绝访问，然后调用服务降级的方法并返回友好提示

   ​	服务降级--> 进而熔断-->恢复链路调用

   **服务限流： flowlimit**

   ​	秒杀高并发等操作，排队，一秒钟N个，有序进行
   
4. ![hystrix](F:\Project\SpringCloud\SpringCloud\cloud-consumer-feign-hystrix-order80\hystrix.png)

![断路打开之后](F:\Project\SpringCloud\SpringCloud\cloud-consumer-feign-hystrix-order80\断路打开之后.png)

5. **消费侧 服务降级**：openfeign 开启熔断 ，配置 feign.hystrix.enabled = true , 启动类使用@EnableHystrix

6. **支付侧服务降级**：使用@EnableCircuitBreaker 开启熔断即可。 

   @EnableHystrix注解里包含了@EnableCircuitBreaker注解

7. ###### 熔断机制概述

   1) **熔断机制是应对雪崩效应的一种微服务链路保护机制，**当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的**降级**，进而**熔断**该节点微服务的调用，快速返回错误的响应信息。

   **当检测到该节点微服务调用响应正常后，恢复调用链路**

   2) **在spring cloud框架里，熔断机制通过Hystrix实现，**Hystrix会监控服务间调用的状况，当失败的调用到一定阈值，缺省是**5秒内20次调用失败，就会启动熔断机制**，熔断机制的注解是HystrixCommand。

8. ###### 熔断类型

   1）熔断打开： 请求不再进行调用当前服务内部设置时钟一般为MTTR（平均故障处理时间），当打开时长达到所设时钟则进入半熔断状态

   2）熔断关闭： 熔断关闭不会对服务进行熔断

   3）熔断半开： 部分请求根据规则调用当前服务，如果请求成功且符合规则认为当前服务恢复正常，关闭熔断

9. ![断路器在什么时间起作用](F:\Project\SpringCloud\SpringCloud\cloud-consumer-feign-hystrix-order80\断路器在什么时间起作用.png)

10. ![断路器开启条件](F:\Project\SpringCloud\SpringCloud\cloud-consumer-feign-hystrix-order80\断路器开启条件.png)