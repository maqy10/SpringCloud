### 1.分布式事务问题

一次业务操作，需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题.

每个服务**内部**的数据一致性由**本地事务来保证**，但是**全局**的数据一致性问题**没法保证**

### 2. Seata

Seata 是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务.

#### 1+3组件 完成

1： 分布式事务处理过程的全局唯一的事务ID    (Transcation ID XID)

3： TC  TM RM  

##### TC：事务协调者：（Seata服务器）

**维护**全局和分支事务的**状态**，**驱动**全局事务提交或回滚。

##### TM: 事务管理器（事务发起方，@GlobalTranscational 注解所在的服务）

定义全局事务的**范围**：开始全局事务、提交或回滚全局事务。

##### RM: 资源管理器 （事务参与方）

**管理分支事务处理的资源**，**与TC交谈以注册分支事务和报告分支事务的状态**，并驱动分支事务提交或回滚。(分支事务注册，状态汇报)



#### 三者关系:

1. TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID;

2. XID在微服务调用链路的上下文中传播;
3. RM 向TC注册分支事务，将其纳入XID对应全局事务的管辖
4. TM 向TC 发起针对XID的全局提交或回滚决议;
5. TC 调度XID下管辖的全部分支事务完成提交或回滚请求。



#### 执行流程：前置镜像->执行sql ->后置镜像完成



库中表存储镜像相关信息，xid为事务ｉｄ，

各微务的库中存储xid (全局事务id)和branch_id　(自己的事务id)



#### 回滚前，现在的数据与after image 进行对比，

没有改变（没有脏写) ,可以回滚，(进行反向补偿)

不同，发生脏写，人工处理



依据前后置镜像进行操作

一二阶段完成后，异步批量删除，before image,after image ,行锁