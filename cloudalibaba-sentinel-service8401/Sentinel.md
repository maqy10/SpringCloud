Sentinel : 熔断、限流、降级，监控

Sentinel： 采用的懒加载机制

Sentinel - Dashboard 中实时监控，只要接口长时间不访问，就会消失

#### 一、流控规则：(存在使用SentinelResource 指定资源名，需要在资源名处配置流控，后续配置的blockHandler处理才会有效,若配置的为url，熔断方法不会有blockHandler配置的方法，走的是默认方法)

资源名：默认为请求路径

1）流控模式：直接（默认）

阈值类型：QPS ,线程数

​	QPS:  每秒请求数

​	阈值：次数上限   

​	当调用 该api的QPS 达到 阈值的时候，进行限流

​	

线程数 : 几个线程去处理发送过来的请求  

​	当调用该api的线程数达到阈值的时候，进行限流



​    2) 流控模式，关联模式。 **关联模式，配置的阈值，是指B的阈值**

​	当关联的资源达到阈值时，就限流自己，

​	当与A关联的资源B达到阈值后，就限流A自己  ，（A调用B，B达到阈值，限流A）

​	B惹事，A挂了



 流控效果：

1. Warm up  预热/冷加载

默认 `coldFactor` 为 3，即请求 QPS 从 `threshold（阈值） / 3` 开始，经预热时长逐渐升至设定的 QPS 阈值。

 最初QPS 为 阈值/3, 经过预热时长后，达到QPS 为阈值，超过阈值，限流

2.  匀速等待：

   每秒匀速通过阈值限定的请求数

#### 二、降级规则 (Sentinel 断路器，没有半开状态)

**RT平均响应时间（秒级）**，当1s内持续进入5个请求，对应时刻的平均响应时间（秒级）均超过阈值，且在时间窗口内通过的请求数 >=5 ，两个条件同时满足后触发降级， （阈值内处理完一组请求QPS）

窗口期过后关闭断路器

RT最大4900（更大的需要通过 -Dcsp.sentinel.statistic.max.rt=xxxx 才能生效）

**异常比例（秒级）**

QPS >= 5 **且**异常比例（秒级统计） 超过阈值时，触发降级，时间窗口结束后，关闭降级

**异常数（分钟级）**

异常数（分钟统计）超过阈值后，触发降级，时间窗口结束后，关闭降级 ,

时间窗口要大于等于60秒.

------

Sentinel 熔断降级会在调用 链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。



当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出DegradeException)

#### 三、热点Key限流

源码： com.alibaba.csp.sentinel.slots.block.BlockException

支持根据QPS限流

支持普通和例外项：

例外项：支持8种基本类型和String类型，当参数=某值时，达到指定阈值后，限流 

#### 四、Sentinel 系统规则（入口规则）

Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。



系统保护规则是应用整体维度的，而不是资源维度的，并且**仅对入口流量生效**。入口流量指的是进入应用的流量（`EntryType.IN`），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。

系统规则支持以下的模式：

- **Load 自适应**（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 `maxQps * minRt` 估算得出。设定参考值一般是 `CPU cores * 2.5`。
- **CPU usage**（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。
- **平均 RT**：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。
- **并发线程数**：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。
- **入口 QPS**：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。(配置低了，系统会宕掉)



#### 五、Sentinel 三个核心API

	1. SphU 定义资源
 	2. Tracer 定义统计 (线程，QPS)
 	3. ContextUtil 定义了上下文

六：持久化到nacos ,[{具体配置}]    //  []必须写，不写不对



[{

​    "resource": "/rateLimit/byUrl",    //资源 名称

​    "limitApp": "default",   // 来源应用

​    "grade": 1,  //阈值类型  0 表示线程数，1表示QPS

​    "count": 1,   //单机阈值

​    "strategy": 0,   //流控模式，0 表示直接，1表示关联，2表示链路

​    "controlBehavior": 0,  //流控效果，0表示快速失败，1表示Warm Up, 2表示排除等待

​    "clusterMode": false  //是否集群

}]